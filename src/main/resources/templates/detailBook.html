<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{layout/header :: commonHead(title=${bookDetail.bookname})}"></head>

<body>
    <nav th:replace="~{layout/header :: commonNav}"></nav>

    <div class="container mt-5" style="max-width: 900px;">
        
        <div class="row g-5">
        
            <!-- 왼쪽: 이미지 영역 -->
            <div class="col-md-4">
            
                <!-- 이미지가 있을 때 -->
                <div th:if="${bookDetail.coverImagePath != null and bookDetail.coverImagePath != ''}">
                    <img th:src="${bookDetail.coverImagePath}" alt="표지" class="img-fluid rounded shadow-sm w-100">
                </div>
                
                <!-- 이미지가 없을 때 -->
                <div th:if="${bookDetail.coverImagePath == null or bookDetail.coverImagePath == ''}"
                     class="text-center text-muted d-flex flex-column align-items-center justify-content-center"
                     style="width: 100%; height: 400px; background-color: #f8f9fa; border-radius: 8px;">
                    <i class="bi bi-image" style="font-size: 5rem;"></i>
                    <p class="mt-2 mb-0">표지 이미지 없음</p>
                </div>
            </div>

            <!-- 오른쪽: 정보 영역 -->
            <div class="col-md-8">
                <h2 th:text="${bookDetail.bookname}">도서 제목</h2>
                <!-- 부제목 (저자 / 출판사) -->
                <p class="lead">
                    <span th:text="${bookDetail.author}">저자</span> / 
                    <span th:text="${bookDetail.publisher}" class="text-muted">출판사</span>
                </p>
                <hr>

                <div class="card">
                    <div class="card-header fw-bold">
                        도서 상세 정보
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Book ID</strong>
                            <span th:text="${bookDetail.bookid}"></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>가격</strong>
                            <span th:text="${#numbers.formatInteger(bookDetail.price, 0, 'COMMA')} + ' 원'"></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>재고</strong>
                            <span th:text="${bookDetail.stock} + ' 권'" 
                                  th:classappend="${bookDetail.stock < 10 && bookDetail.stock > 0} ? 'text-danger fw-bold' : ''"></span>
                        </li>
                        <li class="list-group-item">
                            <strong>상세 설명</strong>
                            <p class="mt-2 mb-0" style="white-space: pre-wrap;" th:text="${bookDetail.description}">상세 설명...</p>
                        </li>
                    </ul>
                </div>
                
                <!-- 버튼 영역 (보안 적용) -->
                <div class="mt-4 d-flex justify-content-between">
                    <a href="/list" class="btn btn-secondary">
                        <i class="bi bi-list-ul"></i> 목록
                    </a>
                    
                    <!-- ADMIN일 때만 수정/삭제 버튼이 보임 -->
                    <div class="d-flex gap-2" sec:authorize="isAuthenticated()">
                        <button class="btn btn-warning" 
                                data-bs-toggle="modal" 
                                data-bs-target="#confirmUpdateModal"
                                th:data-bookid="${bookDetail.bookid}">
                            <i class="bi bi-pencil-square"></i> 수정
                        </button>
                        <button class="btn btn-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#confirmDeleteModal"
                                th:data-bookid="${bookDetail.bookid}">
                            <i class="bi bi-trash"></i> 삭제
                        </button>
                    </div>
                </div>
            </div>
        </div> 
    </div> 

    <!-- 수정 확인 Modal (ADMIN일 때만 렌더링) -->
    <div class="modal fade" id="confirmUpdateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true" sec:authorize="hasRole('ADMIN')">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalLabel">수정 확인</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    이 도서 정보를 수정 페이지로 이동하시겠습니까?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-warning" id="updateConfirmButton">수정 진행</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 Modal (ADMIN일 때만 렌더링) -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" sec:authorize="isAuthenticated()">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">삭제 확인</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    정말로 이 도서 정보를 삭제하시겠습니까? <br>
                    <strong class="text-danger">이 작업은 되돌릴 수 없습니다.</strong>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-danger" id="deleteConfirmButton">삭제 확정</button>
                </div>
            </div>
        </div>
    </div>
    
    <hr class="my-5">

	<div class="card shadow-sm">
	    <div class="card-header bg-light">
	        <h5 class="mb-0"><i class="bi bi-chat-square-text"></i> 도서 리뷰</h5>
	    </div>
	    <div class="card-body">
	        
	        <div th:if="${canReview}" class="mb-4 p-3 border rounded bg-light">
	            <h6>리뷰 작성하기</h6>
	            <form th:action="@{/review/add}" method="post">
	                <input type="hidden" name="bookid" th:value="${bookDetail.bookid}">
	                
	                <div class="mb-2">
	                    <label class="form-label me-2">별점:</label>
	                    <select name="rating" class="form-select d-inline-block w-auto">
	                        <option value="5">★★★★★ (5점)</option>
	                        <option value="4">★★★★☆ (4점)</option>
	                        <option value="3">★★★☆☆ (3점)</option>
	                        <option value="2">★★☆☆☆ (2점)</option>
	                        <option value="1">★☆☆☆☆ (1점)</option>
	                    </select>
	                </div>
	                
	                <div class="mb-2">
	                    <textarea name="content" class="form-control" rows="3" placeholder="솔직한 리뷰를 남겨주세요." required></textarea>
	                </div>
	                <div class="text-end">
	                    <button type="submit" class="btn btn-primary btn-sm">등록</button>
	                </div>
	            </form>
	        </div>
	        
	        <div th:unless="${canReview}" class="alert alert-secondary text-center small">
	            <span sec:authorize="isAnonymous()">로그인 후 </span>구매한 도서에만 리뷰를 작성할 수 있습니다.
	        </div>
	
	        <div class="list-group list-group-flush">
	            <div th:each="review : ${reviews}" class="list-group-item">
	                <div class="d-flex justify-content-between align-items-center mb-1">
	                    <div>
	                        <span class="fw-bold" th:text="${review.writerName}">작성자</span>
	                        <span class="text-warning ms-2">
	                            <span th:text="${'★'.repeat(review.rating)}"></span><span th:text="${'☆'.repeat(5 - review.rating)}"></span>
	                        </span>
	                    </div>
	                    <small class="text-muted" th:text="${#dates.format(review.regdate, 'yyyy-MM-dd HH:mm')}">날짜</small>
	                </div>
	                <p class="mb-1 text-break" th:text="${review.content}">리뷰 내용</p>
	            </div>
	            
	            <div th:if="${reviews == null || reviews.isEmpty()}" class="text-center py-3 text-muted">
	                아직 등록된 리뷰가 없습니다. 첫 번째 리뷰를 남겨보세요!
	            </div>
	        </div>
	    </div>
	</div>

    <th:block th:replace="~{layout/footer :: commonScripts}"></th:block>
    
    <script th:inline="javascript">

        const goList = () => {
            location.href = "/list";
        }
        
        const goUpdate = (bookId) => {
            location.href = "/goUpdate/" + bookId;
        } 
        
        const goDelete = (bookId) => {
            location.href = "/goDelete/" + bookId;
        }

        // '수정' Modal 이벤트 리스너
        const updateModal = document.getElementById('confirmUpdateModal');
        if(updateModal) { 
            updateModal.addEventListener('show.bs.modal', (event) => {
                const button = event.relatedTarget;
                const bookId = button.getAttribute('data-bookid');
                const confirmButton = document.getElementById('updateConfirmButton');
                confirmButton.onclick = () => {
                    goUpdate(bookId);
                };
            });
        }

     	// '삭제' Modal 이벤트 리스너
        const deleteModal = document.getElementById('confirmDeleteModal');
        if(deleteModal) { 
            deleteModal.addEventListener('show.bs.modal', (event) => {
                const button = event.relatedTarget;
                const bookId = button.getAttribute('data-bookid');
                const confirmButton = document.getElementById('deleteConfirmButton');
                confirmButton.onclick = () => {
                    goDelete(bookId);
                };
            });
        }
    </script>
</body>
</html>

