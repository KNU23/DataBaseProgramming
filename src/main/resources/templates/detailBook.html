<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{layout/header :: commonHead(title=${bookDetail.bookname})}"></head>

<body>
    <nav th:replace="~{layout/header :: commonNav}"></nav>

    <div class="container mt-5" style="max-width: 900px;">
        <div th:if="${msg}" class="alert alert-success alert-dismissible fade show" role="alert">
            [[${msg}]]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <div class="row g-5">
        
            <div class="col-md-4">
            
                <div th:if="${bookDetail.coverImagePath != null and bookDetail.coverImagePath != ''}">
                    <img th:src="${bookDetail.coverImagePath}" alt="표지" class="img-fluid rounded shadow-sm w-100">
                </div>
                
                <div th:if="${bookDetail.coverImagePath == null or bookDetail.coverImagePath == ''}"
                     class="text-center text-muted d-flex flex-column align-items-center justify-content-center"
                     style="width: 100%; height: 400px; background-color: #f8f9fa; border-radius: 8px;">
                    <i class="bi bi-image" style="font-size: 5rem;"></i>
                    <p class="mt-2 mb-0">표지 이미지 없음</p>
                </div>
            </div>

            <div class="col-md-8">
                <h2 th:text="${bookDetail.bookname}">도서 제목</h2>
                <p class="lead">
                    <span th:text="${bookDetail.author}">저자</span> / 
                    <span th:text="${bookDetail.publisher}" class="text-muted">출판사</span>
                </p>
                <hr>

                <div class="card">
                    <div class="card-header fw-bold">
                        도서 상세 정보
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>Book ID</strong>
                            <span th:text="${bookDetail.bookid}"></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>가격</strong>
                            <span th:text="${#numbers.formatInteger(bookDetail.price, 0, 'COMMA')} + ' 원'"></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <strong>재고</strong>
                            <span th:text="${bookDetail.stock} + ' 권'" 
                                  th:classappend="${bookDetail.stock < 10 && bookDetail.stock > 0} ? 'text-danger fw-bold' : ''"></span>
                        </li>
                        <li class="list-group-item">
                            <strong>상세 설명</strong>
                            <p class="mt-2 mb-0" style="white-space: pre-wrap;" th:text="${bookDetail.description}">상세 설명...</p>
                        </li>
                    </ul>
                </div>
                
                <div class="mt-4 d-flex justify-content-between">
                    <a href="/list" class="btn btn-secondary">
                        <i class="bi bi-list-ul"></i> 목록
                    </a>
                    
                    <div class="d-flex gap-2" sec:authorize="isAuthenticated()">
                        <button class="btn btn-warning" 
                                data-bs-toggle="modal" 
                                data-bs-target="#confirmUpdateModal"
                                th:data-bookid="${bookDetail.bookid}"
                                sec:authorize="hasRole('ADMIN')">
                            <i class="bi bi-pencil-square"></i> 수정
                        </button>
                        <button class="btn btn-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#confirmDeleteModal"
                                th:data-bookid="${bookDetail.bookid}"
                                sec:authorize="hasRole('ADMIN')">
                            <i class="bi bi-trash"></i> 삭제
                        </button>
                    </div>
                </div>
            </div>
        </div> 
    </div> 

    <div class="modal fade" id="confirmUpdateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true" sec:authorize="hasRole('ADMIN')">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalLabel">수정 확인</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    이 도서 정보를 수정 페이지로 이동하시겠습니까?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-warning" id="updateConfirmButton">수정 진행</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" sec:authorize="isAuthenticated()">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">삭제 확인</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    정말로 이 도서 정보를 삭제하시겠습니까? <br>
                    <strong class="text-danger">이 작업은 되돌릴 수 없습니다.</strong>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-danger" id="deleteConfirmButton">삭제 확정</button>
                </div>
            </div>
        </div>
    </div>
    
    <hr class="my-5">

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-chat-square-text"></i> 도서 리뷰</h5>
        </div>
        <div class="card-body">
            
            <div th:if="${canReview}" class="mb-4 p-3 border rounded bg-light">
                <h6>리뷰 작성하기</h6>
                <form th:action="@{/review/add}" method="post">
                    <input type="hidden" name="bookid" th:value="${bookDetail.bookid}">
                    
                    <div class="mb-2">
                        <label class="form-label me-2">별점:</label>
                        <select name="rating" class="form-select d-inline-block w-auto">
                            <option value="5">★★★★★ </option>
                            <option value="4">★★★★☆ </option>
                            <option value="3">★★★☆☆ </option>
                            <option value="2">★★☆☆☆ </option>
                            <option value="1">★☆☆☆☆ </option>
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <textarea name="content" class="form-control" rows="3" placeholder="솔직한 리뷰를 남겨주세요." required></textarea>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary btn-sm">등록</button>
                    </div>
                </form>
            </div>
            
            <div th:unless="${canReview}" class="alert alert-secondary text-center small">
                <span sec:authorize="isAnonymous()">로그인 후 </span>구매한 도서에만 리뷰를 작성할 수 있습니다.
            </div>
    
            <div class="list-group list-group-flush">
                <div th:each="review : ${reviews}" class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div>
                            <span class="fw-bold" th:text="${review.writerName}">작성자</span>
                            <span class="text-warning ms-2">
                                <span th:text="${'★'.repeat(review.rating)}"></span><span th:text="${'☆'.repeat(5 - review.rating)}"></span>
                            </span>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted me-2" th:text="${#dates.format(review.regdate, 'yyyy-MM-dd HH:mm')}">날짜</small>
                            
                            <div th:if="${currentCustId == review.custid}">
                                <button class="btn btn-sm btn-outline-secondary" 
                                        th:onclick="openEditModal([[${review.reviewId}]], [[${review.content}]], [[${review.rating}]], [[${bookDetail.bookid}]])">
                                    수정
                                </button>
                                <form th:action="@{/review/delete}" method="post" class="d-inline" onsubmit="return confirm('정말 삭제하시겠습니까?');">
                                    <input type="hidden" name="reviewId" th:value="${review.reviewId}">
                                    <input type="hidden" name="bookid" th:value="${bookDetail.bookid}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">삭제</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <p class="mb-1 text-break" th:text="${review.content}">리뷰 내용</p>
                </div>
                
                <div th:if="${reviews == null || reviews.isEmpty()}" class="text-center py-3 text-muted">
                    아직 등록된 리뷰가 없습니다. 첫 번째 리뷰를 남겨보세요!
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">리뷰 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/review/update}" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="reviewId" id="editReviewId">
                        <input type="hidden" name="bookid" id="editBookId">
                        <div class="mb-3">
                            <label class="form-label">별점</label>
                            <select name="rating" id="editRating" class="form-select">
                                <option value="5">★★★★★ </option>
                                <option value="4">★★★★☆ </option>
                                <option value="3">★★★☆☆ </option>
                                <option value="2">★★☆☆☆ </option>
                                <option value="1">★☆☆☆☆ </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">내용</label>
                            <textarea name="content" id="editContent" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">수정 완료</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <th:block th:replace="~{layout/footer :: commonScripts}"></th:block>
    
    <script th:inline="javascript">

        const goList = () => {
            location.href = "/list";
        }
        
        const goUpdate = (bookId) => {
            location.href = "/goUpdate/" + bookId;
        } 
        
        const goDelete = (bookId) => {
            location.href = "/goDelete/" + bookId;
        }

        // '수정' Modal 이벤트 리스너
        const updateModal = document.getElementById('confirmUpdateModal');
        if(updateModal) { 
            updateModal.addEventListener('show.bs.modal', (event) => {
                const button = event.relatedTarget;
                const bookId = button.getAttribute('data-bookid');
                const confirmButton = document.getElementById('updateConfirmButton');
                confirmButton.onclick = () => {
                    goUpdate(bookId);
                };
            });
        }

        // '삭제' Modal 이벤트 리스너
        const deleteModal = document.getElementById('confirmDeleteModal');
        if(deleteModal) { 
            deleteModal.addEventListener('show.bs.modal', (event) => {
                const button = event.relatedTarget;
                const bookId = button.getAttribute('data-bookid');
                const confirmButton = document.getElementById('deleteConfirmButton');
                confirmButton.onclick = () => {
                    goDelete(bookId);
                };
            });
        }
        
        // 리뷰 수정 모달 오픈 함수
        function openEditModal(reviewId, content, rating, bookId) {
            document.getElementById('editReviewId').value = reviewId;
            document.getElementById('editBookId').value = bookId;
            document.getElementById('editContent').value = content;
            document.getElementById('editRating').value = rating;
            
            new bootstrap.Modal(document.getElementById('editReviewModal')).show();
        }
    </script>
</body>
</html>