<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org">
<body>

    <th:block th:fragment="commonScripts">
        
        <footer class="main-footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <h5 class="footer-title"><i class="bi bi-book-half"></i> KNU BookStore</h5>
                        <p class="text-white-50 small">
                            ë‹¹ì‹ ì˜ ì¼ìƒì„ ì±„ìš°ëŠ” íŠ¹ë³„í•œ ì„œì .<br>
                            KNU BookStoreì—ì„œ ì¸ìƒì˜ ì±…ì„ ë§Œë‚˜ë³´ì„¸ìš”.
                        </p>
                        <div class="social-icons">
                            <a href="#"><i class="bi bi-instagram"></i></a>
                            <a href="#"><i class="bi bi-facebook"></i></a>
                            <a href="#"><i class="bi bi-twitter-x"></i></a>
                            <a href="#"><i class="bi bi-youtube"></i></a>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <h5 class="footer-title">ê³ ê°ì„¼í„°</h5>
                        <ul class="list-unstyled text-white-50 small">
                            <li><i class="bi bi-telephone"></i> 010-2162-4487 </li>
                            <li><i class="bi bi-envelope"></i> 202302089@smail.kongju.ac.kr</li>
                            <li><i class="bi bi-geo-alt"></i> ì¶©ë‚¨ ì²œì•ˆì‹œ ì„œë¶êµ¬ ì²œì•ˆëŒ€ë¡œ 1223-24 ê³µì£¼ëŒ€í•™êµì²œì•ˆê³µê³¼ëŒ€í•™</li>
                        </ul>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <h5 class="footer-title">Quick Links</h5>
                        <ul class="list-unstyled footer-links">
                            <li><a href="/list">ì „ì²´ ë„ì„œ ëª©ë¡</a></li>
                            <li><a href="/cart">ì¥ë°”êµ¬ë‹ˆ</a></li>
                            <li><a href="/orderList">ì£¼ë¬¸ ë°°ì†¡ ì¡°íšŒ</a></li>
                        </ul>
                    </div>
                </div>
                <hr class="border-secondary my-4">
                <div class="text-center text-white-50 small">
                    &copy; 2025 KNU BookStore. All Rights Reserved. Designed by Kim Yong Gak.
                </div>
            </div>
        </footer>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <div id="chatbot-container" class="chatbot-container">
            <div class="chatbot-header">
                <div><i class="bi bi-robot"></i> KNU AI ìƒë‹´ì‚¬</div>
                <div class="chatbot-controls">
                    <button id="reset-chat" class="btn-icon" title="ì´ˆê¸°í™”"><i class="bi bi-arrow-clockwise"></i></button>
                    <button id="close-chat" class="btn-icon"><i class="bi bi-x-lg"></i></button>
                </div>
            </div>
            <div id="chatbot-messages" class="chatbot-messages"></div>
            <div class="chatbot-input">
                <input type="text" id="chat-input" placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”..." onkeypress="handleEnter(event)">
                <button onclick="sendMessage()" class="btn-send"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>

        <button id="chatbot-toggle-btn" class="chatbot-toggle-btn">
            <i class="bi bi-chat-dots-fill"></i>
            <span class="pulse-ring"></span>
        </button>

        <script>
            // (ì´ì „ê³¼ ë™ì¼í•œ ì±—ë´‡ ìŠ¤í¬ë¦½íŠ¸ ë¡œì§)
            const chatContainer = document.getElementById('chatbot-container');
            const toggleBtn = document.getElementById('chatbot-toggle-btn');
            const closeBtn = document.getElementById('close-chat');
            const resetBtn = document.getElementById('reset-chat');
            const messagesArea = document.getElementById('chatbot-messages');
            const inputField = document.getElementById('chat-input');
            const STORAGE_KEY_MSG = 'knu_chat_messages';
            const STORAGE_KEY_STATE = 'knu_chat_is_open';

            window.addEventListener('DOMContentLoaded', () => { loadChatState(); loadMessages(); });

            if(toggleBtn) toggleBtn.addEventListener('click', () => setChatState(true));
            if(closeBtn) closeBtn.addEventListener('click', () => setChatState(false));

            function setChatState(isOpen) {
                if (isOpen) {
                    chatContainer.style.display = 'flex';
                    toggleBtn.style.display = 'none';
                    sessionStorage.setItem(STORAGE_KEY_STATE, 'true');
                    setTimeout(() => inputField.focus(), 100); 
                    scrollToBottom();
                } else {
                    chatContainer.style.display = 'none';
                    toggleBtn.style.display = 'block';
                    sessionStorage.setItem(STORAGE_KEY_STATE, 'false');
                }
            }
            function loadChatState() {
                const isOpen = sessionStorage.getItem(STORAGE_KEY_STATE) === 'true';
                setChatState(isOpen);
            }
            function loadMessages() {
                const savedData = sessionStorage.getItem(STORAGE_KEY_MSG);
                if (savedData) {
                    JSON.parse(savedData).forEach(msg => renderMessageHTML(msg.text, msg.type));
                } else {
                    const welcomeMsg = "ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹\në„ì„œ ì¶”ì²œ, ë°°ì†¡ ë¬¸ì˜ ë“± ë¬´ì—‡ì´ë“  ë„ì™€ë“œë¦´ê²Œìš”.";
                    renderMessageHTML(welcomeMsg, 'bot-message');
                }
                scrollToBottom();
            }
            function saveMessageToStorage(text, type) {
                let messages = JSON.parse(sessionStorage.getItem(STORAGE_KEY_MSG) || "[]");
                messages.push({ text: text, type: type });
                sessionStorage.setItem(STORAGE_KEY_MSG, JSON.stringify(messages));
            }
            if(resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if(confirm("ëŒ€í™” ë‚´ìš©ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        sessionStorage.removeItem(STORAGE_KEY_MSG);
                        messagesArea.innerHTML = '';
                        loadMessages();
                    }
                });
            }
            function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
            function sendMessage() {
                const text = inputField.value.trim();
                if (!text) return;
                renderMessageHTML(text, 'user-message');
                saveMessageToStorage(text, 'user-message');
                inputField.value = '';
                
                const loadingId = renderMessageHTML('ë‹µë³€ì„ ì‘ì„±í•˜ê³  ìˆì–´ìš”...', 'bot-message loading-msg');
                const csrfMeta = document.querySelector("meta[name='_csrf']");
                const headerMeta = document.querySelector("meta[name='_csrf_header']");
                
                if (!csrfMeta) { document.getElementById(loadingId).innerText = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."; return; }

                fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', [headerMeta.content]: csrfMeta.content },
                    body: JSON.stringify({ message: text })
                })
                .then(r => r.text())
                .then(data => {
                    document.getElementById(loadingId).remove();
                    renderMessageHTML(data, 'bot-message');
                    saveMessageToStorage(data, 'bot-message');
                })
                .catch(() => {
                    document.getElementById(loadingId).innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                });
            }
            function renderMessageHTML(text, className) {
                const div = document.createElement('div');
                div.id = 'msg-' + Date.now() + Math.random();
                div.className = `message ${className}`;
                div.innerText = text;
                messagesArea.appendChild(div);
                scrollToBottom();
                return div.id;
            }
            function scrollToBottom() { messagesArea.scrollTop = messagesArea.scrollHeight; }
        </script>
    </th:block>
</body>
</html>