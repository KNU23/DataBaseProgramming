<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{layout/header :: commonHead(title='도서 목록')}"></head>

<body>
    <nav th:replace="~{layout/header :: commonNav}"></nav>

    <div class="container mt-5">
        
        <!-- Flash Message 알림창 -->
        <div th:if="${msg}" class="alert alert-success alert-dismissible fade show" role="alert">
            [[${msg}]]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            [[${error}]]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">도서 목록</h2>
        </div>

        <!-- 검색 폼 -->
        <form action="/list" method="get" class="mb-4">
            <div class="input-group">
                <input type="text" class="form-control" name="keyword" 
                       placeholder="책 제목, 출판사 또는 저자 입력" th:value="${keyword}">
                <button class="btn btn-outline-secondary" type="submit">
                    <i class="bi bi-search"></i> 검색
                </button>
            </div>
        </form>

        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th style="width: 5%;">표지</th> 
                    
                    <!-- 정렬 링크가 포함된 헤더 -->
                    <th style="width: 5%;">
                        <a th:href="@{/list(page=${pagingInfo.page}, keyword=${keyword}, sort='bookid', order=${(sort == 'bookid' && order == 'asc') ? 'desc' : 'asc'})}" class="text-white text-decoration-none">
                            ID
                            <i th:if="${sort == 'bookid' && order == 'asc'}" class="bi bi-sort-up"></i>
                            <i th:if="${sort == 'bookid' && order == 'desc'}" class="bi bi-sort-down"></i>
                        </a>
                    </th>
                    <th style="width: 20%;">
                        <a th:href="@{/list(page=${pagingInfo.page}, keyword=${keyword}, sort='bookname', order=${(sort == 'bookname' && order == 'asc') ? 'desc' : 'asc'})}" class="text-white text-decoration-none">
                            제목
                            <i th:if="${sort == 'bookname' && order == 'asc'}" class="bi bi-sort-up"></i>
                            <i th:if="${sort == 'bookname' && order == 'desc'}" class="bi bi-sort-down"></i>
                        </a>
                    </th>
                    <th>
                        <a th:href="@{/list(page=${pagingInfo.page}, keyword=${keyword}, sort='publisher', order=${(sort == 'publisher' && order == 'asc') ? 'desc' : 'asc'})}" class="text-white text-decoration-none">
                            출판사
                            <i th:if="${sort == 'publisher' && order == 'asc'}" class="bi bi-sort-up"></i>
                            <i th:if="${sort == 'publisher' && order == 'desc'}" class="bi bi-sort-down"></i>
                        </a>
                    </th>
                    <th>
                         <a th:href="@{/list(page=${pagingInfo.page}, keyword=${keyword}, sort='author', order=${(sort == 'author' && order == 'asc') ? 'desc' : 'asc'})}" class="text-white text-decoration-none">
                            저자
                            <i th:if="${sort == 'author' && order == 'asc'}" class="bi bi-sort-up"></i>
                            <i th:if="${sort == 'author' && order == 'desc'}" class="bi bi-sort-down"></i>
                        </a>
                    </th>
                    <th>
                         <a th:href="@{/list(page=${pagingInfo.page}, keyword=${keyword}, sort='price', order=${(sort == 'price' && order == 'asc') ? 'desc' : 'asc'})}" class="text-white text-decoration-none">
                            가격
                            <i th:if="${sort == 'price' && order == 'asc'}" class="bi bi-sort-up"></i>
                            <i th:if="${sort == 'price' && order == 'desc'}" class="bi bi-sort-down"></i>
                        </a>
                    </th>
                    <th>
                        <a th:href="@{/list(page=${pagingInfo.page}, keyword=${keyword}, sort='stock', order=${(sort == 'stock' && order == 'asc') ? 'desc' : 'asc'})}" class="text-white text-decoration-none">
                            재고
                            <i th:if="${sort == 'stock' && order == 'asc'}" class="bi bi-sort-up"></i>
                            <i th:if="${sort == 'stock' && order == 'desc'}" class="bi bi-sort-down"></i>
                        </a>
                    </th>
                    
                    <th class="text-center" style="width: 8%;">주문</th>
                </tr>
            </thead>
            <tbody>
			    <tr th:each="bookinfo: ${bookList}">
			        
			        <td>
			            <a th:href="@{/bookid/{id}(id=${bookinfo.bookid})}">
			                <img th:if="${bookinfo.coverImagePath != null and bookinfo.coverImagePath != ''}"
			                     th:src="${bookinfo.coverImagePath}" 
			                     alt="표지" 
			                     class="img-thumbnail" 
			                     style="width: 50px; height: 70px; object-fit: cover;">
			                     
			                <div th:if="${bookinfo.coverImagePath == null or bookinfo.coverImagePath == ''}" 
			                     class="text-center text-muted"
			                     style="width: 50px; height: 70px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
			                    <i class="bi bi-image" style="font-size: 1.5rem;"></i>
			                </div>
			            </a>
			        </td>
			        
			        <td>
			            <a th:text="${bookinfo.bookid}" th:href="@{/bookid/{id}(id=${bookinfo.bookid})}"></a>
			        </td>
			        
			        <td>
			            <a th:href="@{/bookid/{id}(id=${bookinfo.bookid})}" 
			               th:text="${bookinfo.bookname}" 
			               class="text-decoration-none text-dark fw-bold">
			               책 제목
			            </a>
			        </td>
			        <td th:text="${bookinfo.publisher}"></td>
			        <td th:text="${bookinfo.author}"></td>
			        
			        <td class="text-nowrap" th:text="${#numbers.formatInteger(bookinfo.price, 0, 'COMMA')} + '원'"></td>
			        
			        <td>
			            <span class="text-nowrap" 
			                  th:text="${bookinfo.stock} + '권'" 
			                  th:classappend="${bookinfo.stock < 10 && bookinfo.stock > 0} ? 'text-danger fw-bold' : ''">
			            </span>
			        </td>
			        
			        <td class="text-center">
			            <div th:if="${bookinfo.stock > 0}" sec:authorize="isAuthenticated()" class="d-flex justify-content-center gap-2">
			                <form th:action="@{/cart/add}" method="post">
			                    <input type="hidden" name="bookid" th:value="${bookinfo.bookid}">
			                    <input type="hidden" name="count" value="1"> 
			                    <button type="submit" class="btn btn-sm btn-outline-primary">
			                        <i class="bi bi-cart-plus"></i>
			                    </button>
			                </form>
			        
			                <a th:href="@{/addOrder/{bookid}(bookid=${bookinfo.bookid})}" 
			                   class="btn btn-sm btn-success"
			                   title="바로 주문">
			                   <i class="bi bi-credit-card"></i>
			                </a>
			            </div>
			        
			            <button class="btn btn-sm btn-secondary" disabled 
			                    th:if="${bookinfo.stock <= 0}"
			                    sec:authorize="isAuthenticated()">
			               <i class="bi bi-x-circle"></i> 품절
			            </button>
			        </td>
			    </tr>
			    
			    <tr th:if="${bookList == null or bookList.isEmpty()}">
			        <td colspan="9" class="text-center">
			            <span th:if="${keyword != null and keyword != ''}">
			                '[[${keyword}]]'에 대한 검색 결과가 없습니다.
			            </span>
			            <span th:unless="${keyword != null and keyword != ''}">
			                등록된 도서가 없습니다.
			            </span>
			        </td>
			    </tr>
			</tbody>
        </table>
        
        <hr>
        
        <!-- 페이징 (정렬 상태 유지) -->
        <nav aria-label="Page navigation" th:if="${pagingInfo != null and pagingInfo.totalPages > 1}" class="d-flex justify-content-center">
            <ul class="pagination">
                <li class="page-item" th:classappend="${pagingInfo.hasPrev} ? '' : 'disabled'">
                    <a class="page-link" th:href="@{/list(page=${pagingInfo.startPage - 1}, keyword=${keyword}, sort=${sort}, order=${order})}">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item" 
                    th:each="num : ${#numbers.sequence(pagingInfo.startPage, pagingInfo.endPage)}"
                    th:classappend="${num == pagingInfo.page} ? 'active' : ''">
                    <a class="page-link" th:href="@{/list(page=${num}, keyword=${keyword}, sort=${sort}, order=${order})}" th:text="${num}">1</a>
                </li>
                <li class="page-item" th:classappend="${pagingInfo.hasNext} ? '' : 'disabled'">
                    <a class="page-link" th:href="@{/list(page=${pagingInfo.endPage + 1}, keyword=${keyword}, sort=${sort}, order=${order})}">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <th:block th:replace="~{layout/footer :: commonScripts}"></th:block>
</body>
</html>

