<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org">
<head th:replace="~{layout/header :: commonHead(title='장바구니')}"></head>

<body>
    <nav th:replace="~{layout/header :: commonNav}"></nav>

    <div class="container mt-5">
        <h2><i class="bi bi-cart4"></i> 나의 장바구니</h2>
        <hr>
        
        <div th:if="${param.error}" class="alert alert-danger">
            주문 실패: [[${param.error}]]
        </div>

        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>도서명</th>
                    <th>수량</th>
                    <th>가격</th>
                    <th>합계</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${cartList}">
                    <td>
                        <img th:src="${item.coverImagePath}" width="40" class="me-2">
                        <span th:text="${item.bookname}"></span>
                    </td>
                    <td th:text="${item.count} + ' 권'"></td>
                    <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')} + '원'"></td>
                    <td th:text="${#numbers.formatInteger(item.totalPrice, 0, 'COMMA')} + '원'" class="fw-bold"></td>
                    <td>
					    <a th:href="@{/cart/delete/{cartId}(cartId=${item.cartId})}" 
					       class="btn btn-sm btn-danger"
					       onclick="return confirm('정말 삭제하시겠습니까?');">
					        <i class="bi bi-trash"></i> 삭제
					    </a>
					</td>
                </tr>
            </tbody>
        </table>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
		
		<div class="d-flex justify-content-end mt-4">
		    <button type="button" onclick="requestPay()" class="btn btn-primary btn-lg">
		        <i class="bi bi-credit-card"></i> 전체 주문하기
		    </button>
		</div>
		
		<form id="orderForm" th:action="@{/cart/order}" method="post" style="display:none;">
		</form>
		
		<script th:inline="javascript">
		    function requestPay() {
		        var IMP = window.IMP;
		        IMP.init("imp62521676"); // 가맹점 식별코드 입력
		
		        // 안전하게 리스트 가져오기 (null 방지)
		        const myCartList = /*[[${cartList}]]*/ [];
		        
		        let total = 0;
		        
		        // forEach로 합계 계산
				if (myCartList) {
		            myCartList.forEach(item => {
		                total += item.totalPrice;
		           	 });
		        }
		        
				// CSRF 토큰과 헤더 이름 가져오기
		        var token = $("meta[name='_csrf']").attr("content");
		        var header = $("meta[name='_csrf_header']").attr("content");
		        
		        IMP.request_pay({
		            pg: "kakaopay",
		            pay_method: "card",
		            merchant_uid: "order_" + new Date().getTime(),
		            name: "KNU BookStore 도서 주문",
		            amount: total,  
		            buyer_email: "test@test.com", 
		            buyer_name: "구매자이름",
		            buyer_tel: "010-1234-5678"
		        }, function (rsp) {
		        	if (rsp.success) {
		                // 결제 성공 시: 서버에 결제 정보를 전송하여 검증 요청
		                jQuery.ajax({
		                    url: "/cart/order", 
		                    method: "POST",
		                    headers: { "Content-Type": "application/json" },
		                    beforeSend: function(xhr) {
		                        xhr.setRequestHeader(header, token);
		                    },
		                    
		                    data: JSON.stringify({
		                        imp_uid: rsp.imp_uid,            // 포트원 결제 고유 번호
		                        merchant_uid: rsp.merchant_uid,  // 주문 번호
		                        amount: rsp.paid_amount          // 실제 결제된 금액
		                    })
		                }).done(function (response) {
		                    // 서버 응답 처리 (성공 시)
		                    alert("결제 및 주문이 완료되었습니다.");
		                    window.location.href = "/orderList?msg=success";
		                    
		                }).fail(function (xhr, status, error) {
		                    // 서버 응답 처리 (실패 시)
		                    alert("결제는 완료되었으나 서버 검증에 실패했습니다.\n" + xhr.responseText);
		                });

		            } else {
		                // 결제 실패 시
		                alert("결제에 실패하였습니다. 내용: " + rsp.error_msg);
		            }
		        });
		    }
		</script>
    </div>
    <th:block th:replace="~{layout/footer :: commonScripts}"></th:block>
</body>
</html>